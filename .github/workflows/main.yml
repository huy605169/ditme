name: 🚀 SERVER giahuy (Ubuntu)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Thời gian sử dụng'
        required: false
        default: '1_Giờ_30_Phút_(90m)'
        type: choice
        options:
          - '30_Phút_(30m)'
          - '1_Giờ_(60m)'
          - '1_Giờ_30_Phút_(90m)'
          - '2_Giờ_(120m)'
          - '2_Giờ_30_Phút_(150m)'
          - '3_Giờ_(180m)'
          - '3_Giờ_30_Phút_(210m)'
          - '4_Giờ_(240m)'
          - '4_Giờ_30_Phút_(270m)'
          - '5_Giờ_(300m)'
          - '5_Giờ_30_Phút_(330m)'
          - '6_Giờ_(360m)'

jobs:
  Vanmanhgaming-Ubuntu-Setup:
    runs-on: ubuntu-latest
    steps:
      # BANNER CHÀO MỪNG
      - name: KHỞI ĐỘNG HỆ THỐNG
        run: |
          echo ""
          echo "🚀 UBUNTU SERVER"
          echo "Powered by giahuy"
          echo "Thời gian: ${{ github.event.inputs.duration }}"
          echo ""

      # CẤU HÌNH HỆ THỐNG
      - name: CẤU HÌNH HỆ THỐNG
        run: |
          sudo apt update -y
          sudo apt upgrade -y
          sudo apt install -y ufw sudo curl wget
          # Mở SSH port
          sudo ufw allow 22
          sudo ufw --force enable
          echo "Cấu hình hệ thống hoàn tất"

      # TẠO USER root (mật khẩu cố định)
      - name: 👤 TẠO TÀI KHOẢN root
        run: |
          echo "root:12345678" | sudo chpasswd
          sudo usermod -aG sudo root
          sudo passwd -u root
          echo "✅ Tài khoản root đã sẵn sàng với mật khẩu 12345678"

      # THIẾT LẬP TAILSCALE (giữ logic nhưng Linux)
      - name: 🌐 THIẾT LẬP MẠNG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          echo "🌐 ĐANG CÀI ĐẶT TAILSCALE"
          curl -fsSL https://pkgs.tailscale.com/stable/tailscale-keyring.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt update
          sudo apt install -y tailscale
          sudo tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=vanmanhgaming-premium-$GITHUB_RUN_ID --accept-routes --accept-dns --reset
          
          # Lấy IP Tailscale
          TAILSCALE_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "✅ Địa chỉ IP Tailscale: $TAILSCALE_IP"

      # KIỂM TRA KẾT NỐI SSH
      - name: KIỂM TRA KẾT NỐI SSH
        run: |
          if nc -zv ${{ env.TAILSCALE_IP }} 22; then
            echo "✅ Có thể kết nối SSH tới ${{ env.TAILSCALE_IP }}:22"
          else
            echo "❌ Không thể kết nối SSH"
            exit 1
          fi

      # HIỂN THỊ GIAO DIỆN ĐẸP
      - name: 🎉 THÔNG TIN KẾT NỐI
        run: |
          IP=${{ env.TAILSCALE_IP }}
          USER=root
          PASS=12345678
          
          case "${{ github.event.inputs.duration }}" in
            "30_Phút_(30m)") TOTAL_MINUTES=30 ;;
            "1_Giờ_(60m)") TOTAL_MINUTES=60 ;;
            "1_Giờ_30_Phút_(90m)") TOTAL_MINUTES=90 ;;
            "2_Giờ_(120m)") TOTAL_MINUTES=120 ;;
            "2_Giờ_30_Phút_(150m)") TOTAL_MINUTES=150 ;;
            "3_Giờ_(180m)") TOTAL_MINUTES=180 ;;
            "3_Giờ_30_Phút_(210m)") TOTAL_MINUTES=210 ;;
            "4_Giờ_(240m)") TOTAL_MINUTES=240 ;;
            "4_Giờ_30_Phút_(270m)") TOTAL_MINUTES=270 ;;
            "5_Giờ_(300m)") TOTAL_MINUTES=300 ;;
            "5_Giờ_30_Phút_(330m)") TOTAL_MINUTES=330 ;;
            "6_Giờ_(360m)") TOTAL_MINUTES=360 ;;
          esac
          echo "TOTAL_MINUTES=$TOTAL_MINUTES" >> $GITHUB_ENV

          NOW=$(date '+%H:%M:%S')
          END=$(date -d "+$TOTAL_MINUTES minutes" '+%H:%M:%S')
          echo "┌───────────────────────────┐"
          echo "│ 🎉 KẾT NỐI THÀNH CÔNG!       │"
          echo "├───────────────────────────┤"
          echo "│ 🌐 IP: $IP                │"
          echo "│ 👤 User: $USER            │"
          echo "│ 🔐 Pass: $PASS            │"
          echo "│ ⏰ Thời lượng: $TOTAL_MINUTES phút │"
          echo "│ 🕐 Bắt đầu: $NOW          │"
          echo "│ 🕐 Kết thúc: $END         │"
          echo "└───────────────────────────┘"

      # DUY TRÌ PHIÊN LÀM VIỆC
      - name: ⏳ DUY TRÌ PHIÊN LÀM VIỆC
        run: |
          END_TIME=$(date -d "+$TOTAL_MINUTES minutes" +%s)
          while [ $(date +%s) -lt $END_TIME ]; do
            sleep 5
          done
          echo "🎯 ĐÃ HẾT THỜI GIAN - TỰ ĐỘNG DỪNG!"

      # DỌN DẸP CUỐI CÙNG
      - name: 🧹 DỌN DẸP HỆ THỐNG
        if: always()
        run: |
          sudo tailscale down
          echo "✅ Đã dọn dẹp hệ thống"
